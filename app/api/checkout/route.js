import Stripe from 'stripe'; import { NextResponse } from 'next/server'; export const runtime = 'nodejs'; const env=(k) =>process.env[k];
export async function POST(req){ try{ const { priceKey } = await req.json(); const secret=env('STRIPE_SECRET_KEY'); const priceId=env(`STRIPE_PRICE_${String(priceKey||'').toUpperCase()}`); const link=env(`NEXT_PUBLIC_PAYMENT_LINK_${String(priceKey||'').toUpperCase()}`); if(!secret || !priceId){ if(link) return NextResponse.json({url:link}); const base=env('NEXT_PUBLIC_SITE_URL')||'http://localhost:3000'; return NextResponse.json({url:`${base}/contact?reason=${encodeURIComponent(priceKey||'Order')}`}); } const stripe=new Stripe(secret,{apiVersion:'2024-06-20'}); const origin=req.headers.get('origin')||env('NEXT_PUBLIC_SITE_URL')||'http://localhost:3000'; const session=await stripe.checkout.sessions.create({ mode:'payment', line_items:[{price:priceId,quantity:1}], success_url:`${origin}/order?status=success`, cancel_url:`${origin}/order?status=cancel`, payment_method_types:['card','link','us_bank_account'], metadata:{ priceKey } }); return NextResponse.json({ url: session.url }); }catch(e){ console.error(e); return NextResponse.json({ error:'Unable to create checkout session' }, { status:500 }); } }
