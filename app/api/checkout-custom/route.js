import Stripe from 'stripe'; import { NextResponse } from 'next/server'; export const runtime='nodejs'; const env=(k) =>process.env[k];
export async function POST(req){ try{ const { amountUsd, label } = await req.json(); const amount=Math.round(Number(amountUsd||0)*100); const secret=env('STRIPE_SECRET_KEY'); if(!secret || !amount || amount<500){ const base=env('NEXT_PUBLIC_SITE_URL')||'http://localhost:3000'; return NextResponse.json({ url:`${base}/contact?reason=Custom%20Offer` }); } const stripe=new Stripe(secret,{apiVersion:'2024-06-20'}); const origin=env('NEXT_PUBLIC_SITE_URL')||'http://localhost:3000'; const session=await stripe.checkout.sessions.create({ mode:'payment', line_items:[{ price_data:{ currency:'usd', unit_amount:amount, product_data:{ name: label || 'Custom package' } }, quantity:1 }], success_url:`${origin}/order?status=success`, cancel_url:`${origin}/order?status=cancel`, payment_method_types:['card','link'], metadata:{ label } }); return NextResponse.json({ url: session.url }); }catch(e){ console.error(e); return NextResponse.json({ error:'Unable to create session' }, { status:500 }); } }
